<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clone Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bubble-right { background-color: #8de055; color: black; border-radius: 15px 0px 15px 15px; }
        .bubble-left { background-color: #ffffff; color: black; border-radius: 0px 15px 15px 15px; border: 1px solid #e5e7eb; }
        body { background-color: #7289da; }
        /* 設定画面のオーバーレイ */
        #settings-overlay { background-color: rgba(0,0,0,0.5); }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center overflow-hidden">

    <button onclick="openSettings()" class="absolute top-4 right-4 bg-gray-700 text-white p-2 rounded-full opacity-50 hover:opacity-100 z-10 text-xs">
        ⚙️ 設定
    </button>

    <div id="chat-container" class="w-full max-w-md bg-[#7289da] flex flex-col h-full shadow-2xl">
        <div class="bg-slate-800 text-white p-4 text-center font-bold shadow-md z-10">
            Talk with AI Clone
        </div>

        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
            </div>

        <div class="bg-white p-3 flex gap-2 items-center w-full max-w-md fixed bottom-0 z-20 border-t">
            <input type="text" id="user-input" class="flex-1 border p-2 rounded-full focus:outline-none focus:border-blue-500 bg-gray-100" placeholder="メッセージを入力...">
            <button onclick="sendMessage()" class="bg-blue-500 text-white px-5 py-2 rounded-full font-bold transform active:scale-95 transition">送信</button>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div id="settings-overlay" class="absolute inset-0" onclick="closeSettings()"></div>
        <div class="bg-white p-6 rounded-lg shadow-2xl w-11/12 max-w-md z-50 relative animate-fade-in-up">
            <h2 class="text-xl font-bold mb-4 text-gray-800">AI人格設定</h2>
            
            <label class="block text-xs font-bold mb-1 text-gray-600">Gemini API Key</label>
            <input type="password" id="api-key" class="w-full p-2 border rounded mb-4 text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none">

            <label class="block text-xs font-bold mb-1 text-gray-600">システムプロンプト（人格定義）</label>
            <textarea id="system-prompt" rows="8" class="w-full p-2 border rounded mb-4 text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ここに分析された人格データを貼り付けます..."></textarea>

            <button onclick="saveAndClose()" class="w-full bg-green-600 text-white p-3 rounded font-bold hover:bg-green-700 transition">保存して開始</button>
        </div>
    </div>

    <script>
        let chatHistory = [];

        // ページ読み込み時に設定を確認
        window.onload = function() {
            const savedKey = localStorage.getItem("gemini_api_key");
            const savedPrompt = localStorage.getItem("gemini_system_prompt");

            if (savedKey) document.getElementById('api-key').value = savedKey;
            if (savedPrompt) document.getElementById('system-prompt').value = savedPrompt;

            if (!savedKey || !savedPrompt) {
                openSettings();
            }
        };

        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveAndClose() {
            const key = document.getElementById('api-key').value;
            const prompt = document.getElementById('system-prompt').value;

            if(!key) return alert("APIキーを入力してください");

            // ブラウザに保存
            localStorage.setItem("gemini_api_key", key);
            localStorage.setItem("gemini_system_prompt", prompt);
            
            closeSettings();
            if(chatHistory.length === 0) {
                addMessageToUI("会話を開始できます。（設定は保存されました）", "ai");
            }
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const message = inputField.value.trim();
            const apiKey = localStorage.getItem("gemini_api_key");
            const systemPrompt = localStorage.getItem("gemini_system_prompt");

            if (!message) return;
            if (!apiKey) { openSettings(); return; }

            addMessageToUI(message, 'user');
            inputField.value = '';

            const loadingId = addMessageToUI("...", 'ai');

            // 履歴の構築
            let contents = chatHistory.map(msg => ({
                role: msg.role,
                parts: [{ text: msg.content }]
            }));
            contents.push({ role: "user", parts: [{ text: message }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        system_instruction: { parts: { text: systemPrompt } },
                        contents: contents,
                        generationConfig: {
                            temperature: 0.7, // 創造性の調整
                            maxOutputTokens: 200,
                        }
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                const aiText = data.candidates[0].content.parts[0].text;
                document.getElementById(loadingId).innerText = aiText;

                chatHistory.push({ role: "user", content: message });
                chatHistory.push({ role: "model", content: aiText });

            } catch (error) {
                document.getElementById(loadingId).innerText = "エラー: " + error.message;
            }
        }

        function addMessageToUI(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const msgDiv = document.createElement('div');
            const bubble = document.createElement('div');
            const msgId = 'msg-' + Date.now();
            
            msgDiv.className = `flex w-full ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            bubble.className = `p-3 max-w-[85%] text-sm shadow-sm break-words ${sender === 'user' ? 'bubble-right' : 'bubble-left'}`;
            bubble.innerText = text;
            bubble.id = msgId;

            msgDiv.appendChild(bubble);
            messagesDiv.appendChild(msgDiv);
            
            // スクロール追従（少し遅延させて確実に行う）
            setTimeout(() => {
                const container = document.getElementById('messages');
                container.scrollTop = container.scrollHeight;
            }, 50);
            
            return msgId;
        }

        document.getElementById('user-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>
